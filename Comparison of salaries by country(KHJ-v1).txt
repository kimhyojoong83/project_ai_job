# =====================================================
# âœ… [1] ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
# =====================================================
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
from sklearn.cluster import KMeans
import matplotlib.font_manager as fm
import os
import re

# =====================================================
# âœ… [2] ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì „ì²˜ë¦¬
# =====================================================
df = pd.read_csv("ai_job_market.csv")

# ğŸ”¹ locationì—ì„œ êµ­ê°€ ì½”ë“œë§Œ ì¶”ì¶œ (ì˜ˆ: "Tracybury, AR" â†’ "AR")
df['location'] = df['location'].astype(str).apply(lambda x: x.split(',')[-1].strip() if ',' in x else x.strip())

# ğŸ”¹ salary_range_usdì—ì„œ ì• ìˆ«ìë§Œ ì¶”ì¶œ (ì˜ˆ: "92860-109598" â†’ 92860)
def extract_min_salary(s):
    if pd.isna(s):
        return None
    match = re.match(r'(\d+)', str(s))
    return int(match.group(1)) if match else None

df['salary_range_usd'] = df['salary_range_usd'].apply(extract_min_salary)

# =====================================================
# âœ… [3] êµ­ê°€ë³„ í‰ê·  ì—°ë´‰ ê³„ì‚° ë° KMeans í´ëŸ¬ìŠ¤í„°ë§
# =====================================================
country_salary = df.groupby('location')['salary_range_usd'].mean().reset_index()
country_salary.columns = ['country', 'avg_salary']

scaler = StandardScaler()
X_scaled = scaler.fit_transform(country_salary[['avg_salary']])
kmeans = KMeans(n_clusters=3, random_state=42, n_init=10)
country_salary['cluster'] = kmeans.fit_predict(X_scaled)

# í´ëŸ¬ìŠ¤í„°ë³„ í‰ê·  ì—°ë´‰ ê³„ì‚°
cluster_mean = country_salary.groupby('cluster')['avg_salary'].mean().reset_index()
cluster_mean = cluster_mean.sort_values('avg_salary', ascending=False).reset_index(drop=True)
cluster_mean['group'] = ['High Salary', 'Mid Salary', 'Low Salary']

# í´ëŸ¬ìŠ¤í„° â†’ ê·¸ë£¹ ë§¤í•‘
cluster_to_group = dict(zip(cluster_mean['cluster'], cluster_mean['group']))
country_salary['salary_group'] = country_salary['cluster'].map(cluster_to_group)

# =====================================================
# âœ… [4] KR ëˆ„ë½ ì‹œ ê°•ì œ ì¶”ê°€
# =====================================================
if 'KR' not in country_salary['country'].values:
    kr_avg = df['salary_range_usd'].mean()
    kr_row = pd.DataFrame([{'country': 'KR', 'avg_salary': kr_avg, 'salary_group': 'Mid Salary'}])
    country_salary = pd.concat([country_salary, kr_row], ignore_index=True)

# =====================================================
# âœ… [5] ê° ê·¸ë£¹ë³„ ëŒ€í‘œ 5ê°œ êµ­ê°€ (KR í¬í•¨)
# =====================================================
representatives = {}
for group in ['High Salary', 'Mid Salary', 'Low Salary']:
    subset = country_salary[country_salary['salary_group'] == group]
    if subset.empty:
        continue

    if group == 'Low Salary':
        reps = subset.sort_values('avg_salary', ascending=True).head(5)
    else:
        reps = subset.sort_values('avg_salary', ascending=False).head(5)

    # KR í¬í•¨ ë³´ì¥
    if group == 'Mid Salary' and 'KR' not in reps['country'].values:
        kr_row = subset[subset['country'] == 'KR']
        reps = pd.concat([reps, kr_row]).drop_duplicates('country').head(5)

    representatives[group] = reps['country'].tolist()

print("\nğŸ“Œ ëŒ€í‘œ 5ê°œ êµ­ê°€ (KR í¬í•¨):")
for group, countries in representatives.items():
    print(f"{group}: {countries}")

# =====================================================
# âœ… [6] ê° ê·¸ë£¹ë³„ ëŒ€í‘œ ê¸°ìˆ (skill) 2ê°œ ì¶”ì¶œ
# =====================================================
skill_summary = {}

if 'skills_required' in df.columns:
    df['skills_required'] = df['skills_required'].fillna("")
    df_expanded = df.assign(skill=df['skills_required'].str.split(',')).explode('skill')
    df_expanded['skill'] = df_expanded['skill'].str.strip()

    for group in ['High Salary', 'Mid Salary', 'Low Salary']:
        group_countries = country_salary[country_salary['salary_group'] == group]['country']
        group_df = df_expanded[df_expanded['location'].isin(group_countries)]
        top_skills = (
            group_df['skill']
            .value_counts()
            .head(2)
            .index
            .tolist()
        )
        skill_summary[group] = ", ".join(top_skills)
else:
    skill_summary = {g: "N/A" for g in ['High Salary', 'Mid Salary', 'Low Salary']}

print("\nğŸ’¡ ëŒ€í‘œ ê¸°ìˆ  ìƒìœ„ 2ê°œ:")
for group, skills in skill_summary.items():
    print(f"{group}: {skills}")

# =====================================================
# âœ… [7] ì‹œê°í™”
# =====================================================
plt.figure(figsize=(9, 7))
bar_colors = ['#5e3c99', '#1b7837', '#fdb863']

sns.barplot(
    x='group',
    y='avg_salary',
    data=cluster_mean,
    palette=bar_colors
)

plt.title("ê³ Â·ì¤‘Â·ì € ë‚˜ë¼ë³„ í‰ê·  ì—°ë´‰ ë¹„êµ (KR + ëŒ€í‘œ ê¸°ìˆ  í¬í•¨)", fontsize=16, pad=20)
plt.xlabel("ë‚˜ë¼ë³„ ê¸‰ì—¬ ê·¸ë£¹", fontsize=12)
plt.ylabel("í‰ê·  ì—°ë´‰ (USD)", fontsize=12)

# -----------------------------
# ìƒë‹¨ì— ëŒ€í‘œ êµ­ê°€ í‘œì‹œ
# -----------------------------
for i, row in cluster_mean.iterrows():
    group = row['group']
    reps = ", ".join(representatives.get(group, []))
    plt.text(
        i, row['avg_salary'] + (row['avg_salary'] * 0.02),
        f"{group}: {reps}",
        ha='center', fontsize=9, color='black'
    )

# -----------------------------
# ì¤‘ì•™ì— KR ê°•ì¡° (Mid Salary)
# -----------------------------
mid_row = cluster_mean[cluster_mean['group'] == 'Mid Salary']
if not mid_row.empty:
    i = mid_row.index[0]
    y = mid_row['avg_salary'].values[0]
    plt.text(
        i, y / 2,
        "KR",
        ha='center', va='center',
        fontsize=14, fontweight='bold', color='white',
        bbox=dict(facecolor='#1b7837', alpha=0.8, boxstyle='round,pad=0.4')
    )

# -----------------------------
# âœ… ë§‰ëŒ€ ë‚´ë¶€ í•˜ë‹¨ì— ëŒ€í‘œ ê¸°ìˆ  í‘œì‹œ (ê¸€ì”¨ í°ìƒ‰)
# -----------------------------
for i, row in cluster_mean.iterrows():
    group = row['group']
    skills = skill_summary.get(group, "")
    y = row['avg_salary'] * 0.1   # ë§‰ëŒ€ ë‚´ë¶€ í•˜ë‹¨ (10% ìœ„ì¹˜)
    plt.text(
        i, y,
        f"Top Skills:\n{skills}",
        ha='center', va='bottom',
        fontsize=9, color='white', fontweight='bold'
    )

plt.tight_layout()
plt.show()